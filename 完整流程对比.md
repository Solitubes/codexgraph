# CodexGraph Agent å®Œæ•´æµç¨‹å¯¹æ¯”

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†å¯¹æ¯”CodexGraph Agentçš„**åŸå…ˆæµç¨‹**å’Œ**ç°åœ¨æµç¨‹**ï¼Œå±•ç¤ºä»ç”¨æˆ·è¾“å…¥åˆ°æœ€ç»ˆç­”æ¡ˆçš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ã€‚

---

## ğŸ”„ åŸå…ˆæµç¨‹ (CodexGraphAgentGeneral)

### æµç¨‹ç‰¹ç‚¹
- **JSONæ ¼å¼é©±åŠ¨**: ä½¿ç”¨ç»“æ„åŒ–JSONè¿›è¡Œå“åº”
- **å›ºå®šåŠ¨ä½œç±»å‹**: é¢„å®šä¹‰çš„åŠ¨ä½œç±»å‹
- **ç®€å•å¾ªç¯**: æŸ¥è¯¢â†’å“åº”â†’ç”Ÿæˆçš„åŸºæœ¬æµç¨‹

### å®Œæ•´æ‰§è¡Œæµç¨‹

#### 1. ç”¨æˆ·è¾“å…¥é˜¶æ®µ
```
ç”¨æˆ·è¾“å…¥: "åœ¨ä»“åº“é‡Œå®ç°è®¡ç®—åŠŸèƒ½çš„å‡½æ•°æ˜¯å“ªä¸€ä¸ªï¼Ÿ"
â†“
Streamlitç•Œé¢æ¥æ”¶
â†“
CodeChatPage.run_agent() è°ƒç”¨
â†“
CodexGraphAgentGeneral._run() æ‰§è¡Œ
```

#### 2. åˆå§‹åŒ–é˜¶æ®µ
```python
# æ„å»ºåˆå§‹æ¶ˆæ¯
primary_user_prompt = self.primary_user_prompt_template.substitute(
    file_path=file_path, 
    user_query=user_query
)

messages = [
    {
        'role': 'system',
        'content': self.system_prompts  # ç³»ç»Ÿæç¤ºè¯
    },
    {
        'role': 'user',
        'content': primary_user_prompt  # ç”¨æˆ·æŸ¥è¯¢
    }
]
```

#### 3. å¤šè½®å¯¹è¯å¾ªç¯ (æœ€å¤š5è½®)

**ç¬¬1è½® - åˆå§‹æŸ¥è¯¢**
```python
# LLMè°ƒç”¨
response_text = self.llm_call(messages)

# æœŸæœ›çš„JSONå“åº”æ ¼å¼
{
    "thought": "ç”¨æˆ·è¯¢é—®ä»“åº“ä¸­å®ç°è®¡ç®—åŠŸèƒ½çš„å‡½æ•°ï¼Œéœ€è¦æœç´¢ç›¸å…³çš„è®¡ç®—å‡½æ•°",
    "action": "TEXT_QUERIES",
    "action_input": "æŸ¥æ‰¾æ‰€æœ‰æè¿°ä¸­åŒ…å«è®¡ç®—åŠŸèƒ½çš„å‡½æ•°å’Œæ–¹æ³•"
}
```

**è§£æJSONå“åº”**
```python
parsed_response, error_msg = extract_and_parse_json(response_text)
thought, action, action_input = parsed_response.values()

# action = "TEXT_QUERIES"
# action_input = "æŸ¥æ‰¾æ‰€æœ‰æè¿°ä¸­åŒ…å«è®¡ç®—åŠŸèƒ½çš„å‡½æ•°å’Œæ–¹æ³•"
```

**æ‰§è¡ŒTEXT_QUERIESåŠ¨ä½œ**
```python
if action == 'TEXT_QUERIES':
    # è½¬æ¢ä¸ºCypheræŸ¥è¯¢
    cypher_queries = self.cypher_queries_template.substitute(
        text_queries=action_input
    )
    
    # è°ƒç”¨CypherAgentæ‰§è¡ŒæŸ¥è¯¢
    user_response = self.cypher_agent.run(
        cypher_queries, 
        retries=self.max_iterations_cypher
    )
    
    # æ›´æ–°æ¶ˆæ¯å†å²
    messages.append({'role': 'user', 'content': user_response})
```

**CypherAgentæ‰§è¡Œè¿‡ç¨‹**
```python
# 1. æ„å»ºCypheræ¶ˆæ¯
cypher_messages = [
    {'role': 'system', 'content': self.system_prompts},
    {'role': 'user', 'content': cypher_queries}
]

# 2. LLMç”ŸæˆCypheræŸ¥è¯¢
cypher_response = self.llm_call(cypher_messages)
cyphers = extract_cypher_queries(cypher_response)

# 3. æ‰§è¡Œæ¯ä¸ªCypheræŸ¥è¯¢
for cypher in cyphers:
    cypher = add_label_to_nodes(cypher, f'`{self.task_id}`')
    cypher_response, flag = self.graph_db.execute_query_with_timeout(cypher)
    
    if not flag:
        # æŸ¥è¯¢å¤±è´¥ï¼Œéœ€è¦é‡è¯•
        tmp_flag = False

# 4. è¿”å›æŸ¥è¯¢ç»“æœ
user_response = "### Extracted Cypher query 0:\nMATCH (n) WHERE n.description =~ '.*è®¡ç®—.*' RETURN n\n### Response for Cypher query 0:\ncalculate_total_price|è®¡ç®—å•†å“æ€»ä»·æ ¼|def calculate_total_price..."
```

**ç¬¬2è½® - ç»§ç»­æŸ¥è¯¢æˆ–ç”Ÿæˆ**
```python
# å¦‚æœè¿˜éœ€è¦æ›´å¤šä¿¡æ¯ï¼Œç»§ç»­æŸ¥è¯¢
response_text = self.llm_call(messages)

# å¯èƒ½çš„JSONå“åº”
{
    "thought": "å·²ç»æ‰¾åˆ°äº†è®¡ç®—ç›¸å…³çš„å‡½æ•°ï¼Œç°åœ¨å¯ä»¥ç”Ÿæˆç­”æ¡ˆäº†",
    "action": "GENERATE_NEW_CODE",  # æˆ–å…¶ä»–é¢„å®šä¹‰åŠ¨ä½œ
    "action_input": ""
}

# å¦‚æœaction == self.action_typeï¼Œè·³å‡ºå¾ªç¯
if action == self.action_type:
    break
```

#### 4. æœ€ç»ˆç”Ÿæˆé˜¶æ®µ
```python
# æ„å»ºç”Ÿæˆæ¶ˆæ¯
generate_queries = self.generate_queries_template.substitute(
    message=generate_msg,  # "You are ready to do generate New Code."
    file_path=file_path, 
    user_query=user_query
)

messages.append({'role': 'user', 'content': generate_queries})

# ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
answer = self.llm_call(messages)
```

#### 5. æœ€ç»ˆç”¨æˆ·çœ‹åˆ°çš„ç­”æ¡ˆ
```
æ ¹æ®æ‚¨çš„è¯¢é—®ï¼Œæˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹è®¡ç®—ç›¸å…³çš„å‡½æ•°ï¼š

1. calculate_total_price - è®¡ç®—å•†å“æ€»ä»·æ ¼
2. compute_statistics - è®¡ç®—æ•°æ®ç»Ÿè®¡ä¿¡æ¯

è¿™äº›å‡½æ•°éƒ½å®ç°äº†ä¸åŒçš„è®¡ç®—é€»è¾‘ï¼Œæ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚
```

---

## ğŸ†• ç°åœ¨æµç¨‹ (CodexGraphAgentChat)

### æµç¨‹ç‰¹ç‚¹
- **æ ‡è®°é©±åŠ¨**: ä½¿ç”¨ç‰¹æ®Šæ ‡è®°è¿›è¡Œå†…å®¹æå–
- **ä¸‰é˜¶æ®µå¤„ç†**: åˆ†æâ†’æœç´¢â†’ç­”æ¡ˆç”Ÿæˆ
- **æ™ºèƒ½åˆ¤æ–­**: æ ¹æ®ä¸Šä¸‹æ–‡å†³å®šæ˜¯å¦éœ€è¦ç»§ç»­æœç´¢

### å®Œæ•´æ‰§è¡Œæµç¨‹

#### 1. ç”¨æˆ·è¾“å…¥é˜¶æ®µ
```
ç”¨æˆ·è¾“å…¥: "åœ¨ä»“åº“é‡Œå®ç°è®¡ç®—åŠŸèƒ½çš„å‡½æ•°æ˜¯å“ªä¸€ä¸ªï¼Ÿ"
â†“
Streamlitç•Œé¢æ¥æ”¶
â†“
CodeChatPage.run_agent() è°ƒç”¨
â†“
CodexGraphAgentChat._run() æ‰§è¡Œ
```

#### 2. åˆå§‹åŒ–é˜¶æ®µ
```python
# æ„å»ºç”¨æˆ·æŸ¥è¯¢
user_query_issue = f'<questions>\n{user_query}\n<\\questions>\n'

messages = [
    {
        'role': 'system',
        'content': self.system_prompts
    },
    {
        'role': 'user',
        'content': user_query_issue  # åŒ…è£…åçš„ç”¨æˆ·æŸ¥è¯¢
    },
    {
        'role': 'user',
        'content': primary_user_prompt  # ä¸»è¦æç¤ºè¯
    }
]
```

#### 3. å¤šè½®å¯¹è¯å¾ªç¯ (æœ€å¤š5è½®)

**ç¬¬1è½® - åˆ†æé˜¶æ®µ**
```python
# LLMè°ƒç”¨
response_text = self.llm_call(messages)

# æœŸæœ›çš„æ ‡è®°å“åº”æ ¼å¼
"""
[start_of_analysis]
ç”¨æˆ·è¯¢é—®ä»“åº“ä¸­å®ç°è®¡ç®—åŠŸèƒ½çš„å‡½æ•°ã€‚éœ€è¦æœç´¢æ‰€æœ‰åŒ…å«è®¡ç®—é€»è¾‘çš„å‡½æ•°ï¼Œå¯èƒ½åŒ…æ‹¬æ•°å­¦è®¡ç®—ã€æ•°æ®å¤„ç†ã€ç®—æ³•å®ç°ç­‰ã€‚éœ€è¦æŸ¥æ‰¾FUNCTIONå’ŒMETHODèŠ‚ç‚¹ä¸­åŒ…å«"è®¡ç®—"ã€"calculate"ã€"compute"ç­‰å…³é”®è¯çš„æè¿°ã€‚
[end_of_analysis]

[start_of_code_search]
### Text Query 1
æŸ¥æ‰¾æ‰€æœ‰æè¿°ä¸­åŒ…å«"è®¡ç®—"å…³é”®è¯çš„å‡½æ•°å’Œæ–¹æ³•
[end_of_code_search]
"""
```

**æå–ä¸åŒéƒ¨åˆ†çš„å†…å®¹**
```python
extracted_analysis = extract_text_between_markers(
    response_text, '[start_of_analysis]', '[end_of_analysis]')
extracted_code_search = extract_text_between_markers(
    response_text, '[start_of_code_search]', '[end_of_code_search]')
answer_question = extract_text_between_markers(
    response_text, '[start_of_answer]', '[end_of_answer]')
```

**æ‰§è¡Œä»£ç æœç´¢**
```python
if extracted_code_search:
    # è½¬æ¢ä¸ºCypheræŸ¥è¯¢
    cypher_queries = self.cypher_queries_template.substitute(
        text_queries=extracted_code_search
    )
    
    # è°ƒç”¨CypherAgentæ‰§è¡ŒæŸ¥è¯¢
    user_response = self.cypher_agent.run(
        cypher_queries, 
        retries=self.max_iterations_cypher
    )
    
    # æ›´æ–°æ¶ˆæ¯å†å²
    messages.append({'role': 'user', 'content': user_response})
```

**CypherAgentæ‰§è¡Œè¿‡ç¨‹ (ä¸åŸå…ˆç›¸åŒ)**
```python
# 1. æ„å»ºCypheræ¶ˆæ¯
cypher_messages = [
    {'role': 'system', 'content': self.system_prompts},
    {'role': 'user', 'content': cypher_queries}
]

# 2. LLMç”ŸæˆCypheræŸ¥è¯¢
cypher_response = self.llm_call(cypher_messages)
cyphers = extract_cypher_queries(cypher_response)

# 3. æ‰§è¡Œæ¯ä¸ªCypheræŸ¥è¯¢
for cypher in cyphers:
    cypher = add_label_to_nodes(cypher, f'`{self.task_id}`')
    cypher_response, flag = self.graph_db.execute_query_with_timeout(cypher)

# 4. è¿”å›æŸ¥è¯¢ç»“æœ
user_response = "### Extracted Cypher query 0:\nMATCH (n) WHERE (n:METHOD OR n:FUNCTION) AND n.description =~ '.*è®¡ç®—.*' RETURN n.name, n.description, n.code, labels(n) as node_type\n### Response for Cypher query 0:\ncalculate_total_price|è®¡ç®—å•†å“æ€»ä»·æ ¼ï¼ŒåŒ…æ‹¬ç¨è´¹å’ŒæŠ˜æ‰£|def calculate_total_price(items, tax_rate, discount):..."
```

**ç¬¬2è½® - æ™ºèƒ½åˆ¤æ–­é˜¶æ®µ**
```python
# ç»§ç»­å¯¹è¯
response_text = self.llm_call(messages)

# å¯èƒ½çš„å“åº”
"""
#### Concise Summarization:
é€šè¿‡æœç´¢æ‰¾åˆ°äº†2ä¸ªåŒ…å«è®¡ç®—åŠŸèƒ½çš„å‡½æ•°ï¼šcalculate_total_priceå’Œcompute_statisticsã€‚è¿™äº›å‡½æ•°éƒ½åŒ…å«"è®¡ç®—"å…³é”®è¯ï¼Œç¬¦åˆç”¨æˆ·éœ€æ±‚ã€‚

Then if it's sufficient, please continue answering in the following format:
[start_of_answer]
### Answer
- Analysis: ç”¨æˆ·è¯¢é—®ä»“åº“ä¸­å®ç°è®¡ç®—åŠŸèƒ½çš„å‡½æ•°
- Conclusion: æ‰¾åˆ°äº†2ä¸ªä¸»è¦çš„è®¡ç®—å‡½æ•°
- Source code reference: calculate_total_price, compute_statistics
[end_of_answer]
"""
```

**æå–ç­”æ¡ˆéƒ¨åˆ†**
```python
answer_question = extract_text_between_markers(
    response_text, '[start_of_answer]', '[end_of_answer]')

if answer_question:
    break  # æœ‰ç­”æ¡ˆäº†ï¼Œç»“æŸå¾ªç¯
```

#### 4. æœ€ç»ˆç­”æ¡ˆç”Ÿæˆé˜¶æ®µ
```python
# æ„å»ºç”Ÿæˆæ¶ˆæ¯
generate_queries = self.generate_queries_template.substitute(
    message='You are ready to do answer question.',
    user_query=user_query
)

messages.append({'role': 'user', 'content': generate_queries})

# è°ƒç”¨generateæ–¹æ³•
answer = self.generate(messages)
```

**generateæ–¹æ³•æ‰§è¡Œ**
```python
def generate(self, messages):
    messages = deepcopy(messages)
    # æ›¿æ¢ç³»ç»Ÿæç¤ºè¯
    messages = replace_system_prompt(messages, SYSTEM_PROMPT)
    response_text = self.llm_call(messages)
    return response_text
```

#### 5. æœ€ç»ˆç”¨æˆ·çœ‹åˆ°çš„ç­”æ¡ˆ
```
## answer: 
æ ¹æ®æ‚¨çš„è¯¢é—®ï¼Œæˆ‘åœ¨ä»“åº“ä¸­æ‰¾åˆ°äº†ä»¥ä¸‹å®ç°è®¡ç®—åŠŸèƒ½çš„å‡½æ•°ï¼š

1. **calculate_total_price** - è®¡ç®—å•†å“æ€»ä»·æ ¼
   - åŠŸèƒ½ï¼šè®¡ç®—å•†å“æ€»ä»·æ ¼ï¼ŒåŒ…æ‹¬ç¨è´¹å’ŒæŠ˜æ‰£
   - ä»£ç ï¼š`def calculate_total_price(items, tax_rate, discount): ...`

2. **compute_statistics** - è®¡ç®—æ•°æ®ç»Ÿè®¡ä¿¡æ¯  
   - åŠŸèƒ½ï¼šè®¡ç®—æ•°æ®ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¹³å‡å€¼ã€ä¸­ä½æ•°ç­‰
   - ä»£ç ï¼š`def compute_statistics(data): ...`

## analysis: 
é€šè¿‡å›¾æ•°æ®åº“çš„æè¿°æœç´¢åŠŸèƒ½ï¼Œæˆ‘æ‰¾åˆ°äº†æ‰€æœ‰æè¿°ä¸­åŒ…å«"è®¡ç®—"å…³é”®è¯çš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°éƒ½å®ç°äº†ä¸åŒçš„è®¡ç®—é€»è¾‘ï¼Œæ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚

## reference: 
calculate_total_priceå‡½æ•° - ä½äºutils/price_calculator.py
compute_statisticså‡½æ•° - ä½äºutils/data_analyzer.py
```

---

## ğŸ“Š æµç¨‹å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | åŸå…ˆæµç¨‹ (General) | ç°åœ¨æµç¨‹ (Chat) |
|------|-------------------|-----------------|
| **å“åº”æ ¼å¼** | JSONç»“æ„åŒ– | æ ‡è®°åˆ†éš” |
| **çµæ´»æ€§** | å›ºå®šåŠ¨ä½œç±»å‹ | åŠ¨æ€å†…å®¹æå– |
| **åˆ†æèƒ½åŠ›** | ç®€å•æ€è€ƒ | è¯¦ç»†åˆ†æ+ä»£ç æœç´¢+ç­”æ¡ˆ |
| **é”™è¯¯å¤„ç†** | åŸºç¡€é‡è¯• | æ™ºèƒ½åˆ¤æ–­+ä¸Šä¸‹æ–‡æ„ŸçŸ¥ |
| **ç”¨æˆ·ä½“éªŒ** | æŠ€æœ¯å¯¼å‘ | å¯¹è¯å¯¼å‘ |
| **æ‰©å±•æ€§** | éœ€è¦ä¿®æ”¹åŠ¨ä½œç±»å‹ | é€šè¿‡æ ‡è®°è½»æ¾æ‰©å±• |
| **ä»£ç å¤æ‚åº¦** | ä¸­ç­‰ | è¾ƒé«˜ |
| **ç»´æŠ¤æ€§** | è¾ƒå¥½ | ä¼˜ç§€ |

## ğŸ¯ å…³é”®å·®å¼‚ç‚¹

### 1. **å“åº”æ ¼å¼**
- **åŸå…ˆ**: ä¸¥æ ¼çš„JSONæ ¼å¼ï¼Œéœ€è¦è§£æ
- **ç°åœ¨**: è‡ªç„¶çš„æ ‡è®°æ ¼å¼ï¼Œæ˜“äºæå–

### 2. **å¤„ç†é€»è¾‘**
- **åŸå…ˆ**: åŸºäºé¢„å®šä¹‰åŠ¨ä½œç±»å‹çš„æ¡ä»¶åˆ¤æ–­
- **ç°åœ¨**: åŸºäºå†…å®¹æå–çš„æ™ºèƒ½åˆ¤æ–­

### 3. **ç”¨æˆ·ä½“éªŒ**
- **åŸå…ˆ**: æŠ€æœ¯æ€§å¼ºï¼Œé€‚åˆå¼€å‘è€…
- **ç°åœ¨**: è‡ªç„¶å¯¹è¯ï¼Œé€‚åˆæ™®é€šç”¨æˆ·

### 4. **æ‰©å±•æ–¹å¼**
- **åŸå…ˆ**: éœ€è¦ä¿®æ”¹ä»£ç æ·»åŠ æ–°åŠ¨ä½œç±»å‹
- **ç°åœ¨**: é€šè¿‡æ·»åŠ æ–°æ ‡è®°å³å¯æ‰©å±•åŠŸèƒ½

## ğŸ”® é€‰æ‹©å»ºè®®

### ä½¿ç”¨åŸå…ˆæµç¨‹çš„åœºæ™¯:
- éœ€è¦ä¸¥æ ¼çš„ç»“æ„åŒ–å“åº”
- å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜
- å›¢é˜Ÿæœ‰è¾ƒå¼ºçš„æŠ€æœ¯èƒŒæ™¯
- éœ€è¦å¿«é€ŸåŸå‹å¼€å‘

### ä½¿ç”¨ç°åœ¨æµç¨‹çš„åœºæ™¯:
- éœ€è¦æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- è¦æ±‚çµæ´»çš„å¯¹è¯èƒ½åŠ›
- éœ€è¦æ™ºèƒ½çš„ä¸Šä¸‹æ–‡ç†è§£
- é¢å‘æ™®é€šç”¨æˆ·çš„äº§å“

## ğŸ“ æ€»ç»“

ä¸¤ä¸ªæµç¨‹å„æœ‰ä¼˜åŠ¿ï¼š
- **åŸå…ˆæµç¨‹**æ›´é€‚åˆæŠ€æœ¯å¯¼å‘çš„åº”ç”¨ï¼Œç»“æ„æ¸…æ™°ï¼Œæ€§èƒ½ç¨³å®š
- **ç°åœ¨æµç¨‹**æ›´é€‚åˆç”¨æˆ·å¯¼å‘çš„åº”ç”¨ï¼Œä½“éªŒè‡ªç„¶ï¼ŒåŠŸèƒ½å¼ºå¤§

é€‰æ‹©å“ªä¸ªæµç¨‹ä¸»è¦å–å†³äºæ‚¨çš„å…·ä½“éœ€æ±‚å’Œç›®æ ‡ç”¨æˆ·ç¾¤ä½“ã€‚
